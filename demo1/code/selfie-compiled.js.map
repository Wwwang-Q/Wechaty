{"version":3,"sources":["selfie.js"],"names":[],"mappings":"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","file":"selfie-compiled.js","sourcesContent":["/**\n * Created by wangqi on 2017/5/17.\n */\n/*用户发送'selfie',回复\"请发一张你的头像\"。\n * 用户回复消息为图片格式,则获取评分。否则,回复\"发送的不是图片格式,请重新发送selfie\"\n *\n * 用户发送'selfie',则开启bot.on('message',selfie)监听,并将用户存入列表中\n * 若列表为空,则移除监听。*/\n\nimport {Wechaty, Room, Config, Message} from 'wechaty';\nimport {createWriteStream, writeFileSync}  from 'fs'\n\nconst bot = Wechaty.instance();\nvar needle = require('needle');\nvar selfieList = [];\nbot\n    .on('scan', (url, code)=> {\n        let loginUrl = url.replace('qrcode', 'l')\n        require('qrcode-terminal').generate(loginUrl)\n        console.log(url)\n    })\n\n    .on('login', user => console.log(`User ${user} logined`))\n\n    .on('message', async function (m) {\n        const contact = m.from();\n        // console.log(\"人\");\n        const content = m.content();\n        const room = m.room();\n        if (room) {\n            console.log(`Room:${room.topic()}、${contact}发来${content}`)\n        } else {\n            console.log(`${contact}:${content}`)\n        }\n        if (m.self()) return;\n        console.log('speak')\n        if (/^selfie$/i.test(content)) {       //忽略大小写\n            m.say('请发一张你的头像');\n            if (selfieList.length == 0) {       //如果列表为空,说明没有selfie监听。\n                selfieList.push(contact);\n\n                bot.on('message', async function selfie(n) {\n                    // console.log('selfie监听')\n                    const contact1 = n.from();\n                    const content1 = n.content();\n                    if (/^selfie$/i.test(content1) || n.self()) return;   //如果是selfie命令,就不继续。防止重复发送'selfie'出错。\n                    // console.log('speak2');\n                    selfieList.forEach((person, index)=> {   //如果在列表中且是同一个人。\n                        if (person == contact1) {\n\n                            if (n.type() == 3) {  //发送的是图片格式\n                                n.say(`${contact1},我们正在飞速分析您的照片,请耐心等待。`);\n                                saveMediaFile(n);\n\n                            } else {\n                                n.say('发送的不是图片格式,请重新发送selfie.');\n                            }\n\n                            selfieList.splice(index, 1)//移除这个人\n                            return  //每个人只可能出现一次,所以出现一次后,就终止。\n                        }\n                    })\n                    if (!selfieList.length) bot.removeListener('message', selfie);  //如果列表为空,则移除监听。\n                })\n            }\n\n            else if (!selfieList.includes(contact)) selfieList.push(contact); //列表中如果已有此人,就不添加。\n\n        }\n\n    })\n\n    .init()\n\nfunction saveMediaFile(message) {\n    const filename = message.filename()\n    console.log('IMAGE local filename: ' + filename)\n\n    const fileStream = createWriteStream('../image/' + filename)\n\n    console.log('start to readyStream()')\n    message.readyStream()\n        .then(stream => {   //下载图片到本地\n            stream.pipe(fileStream)\n                .on('close', () => {\n                    console.log('finish readyStream()');\n                    var data = [{\n                        file: '../image/' + filename,\n                        content_type: 'image/png'\n                    }];\n                    needle\n                        .post('111.207.243.71:8000/Imagetest', data, {multipart: true}, function (err, res) {\n                            let score = res.body.data;\n                            console.log(score);\n                            if (0 <= score && score <= 40) {\n                                message.say(`你的头像得分是${score}分!难道您就是传说中的外星人?人类无法欣赏您的颜值`)\n                            }\n                            else if (40 < score && score < 60) {\n                                message.say(`你的头像得分是${score}分!加油,马上就要及格了哦~`)\n                            }\n                            else if (60 < score && score < 80) {\n                                message.say(`你的头像得分是${score}分!真的好想认识一下像您这样好看的人啊!`)\n                            }\n                            else if (90 > score && score >= 80) {\n                                message.say(`你的头像得分是${score}分!我就问一句,长得好看是一种怎样的体验?`)\n                            }\n                            else if (95 > score && score >= 90) {\n                                message.say(`你的头像得分是${score}分!天啊,我长这么大还从没见过这么好看的人!!`)\n                            }\n                            else if (100 >= score && score >= 95) {\n                                message.say(`你的头像得分是${score}分!原来世界上真的有您这样颜值爆表的人类!!`)\n                            }\n\n                        })\n                })\n                .catch(e => console.log('stream error:' + e))\n        })\n}\n\n\n\n\n\n"]}